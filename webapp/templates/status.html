<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis in Progress - Azure Resource Discovery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .progress-container {
            max-width: 600px;
            margin: 0 auto;
        }
        .status-card {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: none;
        }
        .spinner-border-lg {
            width: 3rem;
            height: 3rem;
        }
        .status-running { color: #0078d4; }
        .status-completed { color: #28a745; }
        .status-error { color: #dc3545; }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #0078d4;">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-cloud me-2"></i>
                Azure Resource Discovery
            </a>
        </div>
    </nav>

    <div class="container my-5">
        <div class="progress-container">
            <div class="card status-card">
                <div class="card-body text-center p-5">
                    <div id="status-content">
                        <!-- Content will be updated by JavaScript -->
                        <div class="spinner-border spinner-border-lg status-running mb-4" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h3 class="status-running">Initializing Analysis...</h3>
                        <p class="text-muted">Please wait while we analyze your Azure resources</p>
                    </div>

                    <div class="progress mb-4" style="height: 10px;">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 10%" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>

                    <div id="progress-text" class="small text-muted">
                        Starting analysis...
                    </div>
                </div>
            </div>

            <!-- Analysis Steps -->
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-list-check me-2"></i>
                        Analysis Steps
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li id="step-1" class="mb-2">
                                    <i id="icon-1" class="fas fa-clock text-muted me-2"></i>
                                    Connecting to Azure
                                </li>
                                <li id="step-2" class="mb-2">
                                    <i id="icon-2" class="fas fa-clock text-muted me-2"></i>
                                    Discovering Resources
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li id="step-3" class="mb-2">
                                    <i id="icon-3" class="fas fa-clock text-muted me-2"></i>
                                    Fetching Pricing Data
                                </li>
                                <li id="step-4" class="mb-2">
                                    <i id="icon-4" class="fas fa-clock text-muted me-2"></i>
                                    Generating Report
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const sessionId = '{{ session_id }}';
        let currentStep = 0;
        
        function updateStatus() {
            fetch(`/api/status/${sessionId}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Status update:', data);
                    
                    if (data.status === 'running') {
                        updateProgress(data.progress || 'Processing...');
                    } else if (data.status === 'completed') {
                        showCompleted();
                        setTimeout(() => {
                            window.location.href = `/results/${sessionId}`;
                        }, 2000);
                    } else if (data.status === 'error') {
                        showError(data.error || 'An error occurred');
                    }
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                });
        }
        
        function updateProgress(message) {
            document.getElementById('progress-text').textContent = message;
            
            // Update progress bar based on message content
            let progress = 10;
            let step = 1;
            
            if (message.includes('Discovering') || message.includes('resources')) {
                progress = 40;
                step = 2;
            } else if (message.includes('cost') || message.includes('pricing')) {
                progress = 70;
                step = 3;
            } else if (message.includes('Generating') || message.includes('report')) {
                progress = 90;
                step = 4;
            }
            
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-bar').setAttribute('aria-valuenow', progress);
            
            // Update step indicators
            for (let i = 1; i <= step; i++) {
                const icon = document.getElementById(`icon-${i}`);
                if (icon) {
                    icon.className = 'fas fa-check-circle text-success me-2';
                }
            }
        }
        
        function showCompleted() {
            document.getElementById('status-content').innerHTML = `
                <i class="fas fa-check-circle fa-4x text-success mb-4"></i>
                <h3 class="text-success">Analysis Complete!</h3>
                <p class="text-muted">Redirecting to results...</p>
            `;
            
            document.getElementById('progress-bar').className = 'progress-bar bg-success';
            document.getElementById('progress-bar').style.width = '100%';
            document.getElementById('progress-text').textContent = 'Analysis completed successfully!';
            
            // Mark all steps as complete
            for (let i = 1; i <= 4; i++) {
                const icon = document.getElementById(`icon-${i}`);
                if (icon) {
                    icon.className = 'fas fa-check-circle text-success me-2';
                }
            }
        }
        
        function showError(error) {
            document.getElementById('status-content').innerHTML = `
                <i class="fas fa-exclamation-triangle fa-4x text-danger mb-4"></i>
                <h3 class="text-danger">Analysis Failed</h3>
                <p class="text-muted">${error}</p>
                <a href="/" class="btn btn-primary mt-3">Try Again</a>
            `;
            
            document.getElementById('progress-bar').className = 'progress-bar bg-danger';
            document.getElementById('progress-text').textContent = 'Error: ' + error;
        }
        
        // Poll for status updates every 2 seconds
        const statusInterval = setInterval(updateStatus, 2000);
        
        // Initial status check
        updateStatus();
        
        // Clean up interval when page is unloaded
        window.addEventListener('beforeunload', () => {
            clearInterval(statusInterval);
        });
    </script>
</body>
</html>